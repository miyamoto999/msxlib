# msxlib

[msx0_httpget](https://github.com/miyamoto999/msx0_httpget)や非公開のツールを作る時に作ったZ88DKのCコンパイラで使えるMSX用の関数などを集めたライブラリになります。

# ビルド方法

Z88DKのインストールされたUNIX系のOS上で

~~~bash
./build.sh
~~~

を実行すると完了し、./libsディレクトリにasmroutine.lib、bios.lib、iot.lib、msxlib.lib、slot.lib、vdp.libが生成されます。


## ソースツリーの簡単な説明
~~~
.
|-- README.md                       このファイル
|-- doc
|   `-- memo.md                     開発メモ？のようなもの
|-- include
|   `-- msxlib                      C言語のヘッダファイル
|       `-- asm                     asmのヘッダファイル
|-- libs                            ビルド後、ライブラリファイルが格納される
|-- sample
|   `-- msx0                        MSX0用のサンプルプログラム
|       |-- clrrsd                      レジーム機能のセーブデータを削除するコマンド
|       |-- iotget                      IOTノードの値の取得
|       |-- iotput                      IOTノードの値の設定
|       |-- tree                        IOTノードツリーを表示
|       `-- wifislct                    WiFiの接続先を自動的に切り替える
|-- src                             ソースファイル
|   |-- asmroutine                  アセンブラ用のルーチン
|   |-- bcdf                        MSXのBCD実数を文字列やdouble型への変換
|   |-- bfile                       バッファー℃ファイル入出力
|   |-- bios                        MSX-BIOSを呼び出す
|   |   |-- msxmain_dct_*.asm           BASIC上からMAIN-BIOSを呼び出す関数
|   |   |-- msxmain_dos_*.asm           DOS上からMAIN-BIOSを呼び出す関数
|   |   |-- msxsub_dct_*.asm            BASIC上からSUB-BIOSを呼び出す関数
|   |   `-- msxsub_dos_*.asm            DOS上からMAIN-BIOSを呼び出す関数
|   |-- doscall
|   |   |-- dos1_*.asm              DOS1のファンクションコールを呼び出す関数
|   |   |-- dos2_*.asm              DOS2のファンクションコールを呼び出す関数          
|   |   `-- dos_scode.asm           自作のZ80エミュレータの終了コードを設定するファンクションコールを呼び出す関数
|   |-- dskcall
|   |   |-- dsk1_*.asm              DOS1のファンクションコールをBASIC上のマシン語から呼び出す関数
|   |   `-- dsk2_*.asm              DOS2のファンクションコールをBASIC上のマシン語から呼び出す関数
|   |-- iot                         MSX0のIOT関係の関数
|   |-- net                         MSX0のネットワーク(TCP)通信を行う関数
|   |-- rbuf                        リングバッファ
|   |-- slot                        インタースロットコール
|   |-- vdp                         VDP操作関係の関数
|   `-- *.asm, *.c                  その他のソース
|-- tests                           テストプログラム
`-- tools                           ビルドで使うツール
~~~

各関数やサブルーチンの説明は別のファイルで行う。
- [iot関係](doc/iot.md)

更新履歴
- 2025/5/11
    - MSX-DOS1用の差し替え用のcreat_dos1()、open_dos1()、close_dos1()、read_dos1()、write_dos1()、lseek_dos1()、stat_dos1()を追加
    - MSX-DOS1用のcreat_dos1()など追加に際してz88dkのmsx_crt0.asmなどの変更が必要だったのでmsxlibのmake時にコピーしてパッチをあてるようにした。つまり、creat()などを差し替える場合それを使う必要がある。
    - 実行中のDOSカーネルのメジャーバージョンを取得する関数を追加
    - MSX-DOS2の_FTIME(ファイルのタイムスタンプ取得、変更)ファンクションコールを呼び出す関数を追加
    - doscall.libをmsxlib.libに統合
- 2025/4/28
    - ソースコードの整理
    - DOS2のリダイレクトが動作するようにfgetc_cons、fputc_consを変更した(pragma-redirectで関数を差し替える必要がある)
- 2025/4/27
    - VRAMのリドーライト関数をアセンブリ言語化した
    - VRAMのブロックリードライト関数を追加
    - VDPレジスタに設定する値をワークエリアに保存するルーチンの見直し
    - SCREEN 7での表示ページを設定する関数を追加
- 2025/4/12
    - VDPのHMMCコマンドを呼び出す関数をアセンブリ言語で書き直した。
- 2025/3/13
    - VDPのHMMCコマンドを呼び出す関数を追加(C言語ベース)
    - VDPのステータスレジスタを読む関数を追加
    - 漢字モードを変更、取得する関数を追加
    - VRAMのリードライト関数を追加
    - そのたいろいろ
- 2025/1/11
    - ドキュメントをちょっと更新や追加
- 2025/1/6
    - MSX0のIOTノードから実数値を取得する関数(iot_getbcdf()関数)を追加。
- 2025/1/5
    - レジュームセーブデータを削除するコマンド(clrrsd.com)をsampleに追加
- 2024/12/22
    - rbuf_unget()関数のインターフェイスを変更
    - テストプログラムを変更
    - その他、いろいろ変更
- 2024/12/9
    - mapファイルからパブリックなシンボルをC言語の#defineに変換するツールを追加
- 2024/12/8
    - 残りの_STROUT以外のDOS1ファンクションコールを呼び出す関数を追加
- 2024/12/2
    - _GDATE(日付の取得)、_GTIME(時刻の取得)、_SDATE(日付の設定)、_STIME(時刻の設定)ファンクションコールを呼び出す関数を追加
    - _WRZER(ゼロフィルを行うランダム書き込み)ファンクションコールを呼び出す関数を追加
- 2024/12/1
    - _SETRND(ランダムレコードの設定)ファンクションコールを呼び出す関数を追加
    - _FSIZE(ファイルサイズ取得)ファンクションコールを呼び出す関数を追加
- 2024/11/30
    - _WRRND(ランダム書き込み)ファンクションコールを呼び出す関数を追加
- 2024/11/29
    - _RDRND(ランダム読み込み)、_WRSEQ(シーケンシャルな書き込み)ファンクションコールを呼び出す関数を追加
- 2024/11/28
    - _ALLOC(アロケーション情報の取得)、_LOGIN(ログインベクタ取得)ファンクションコールを呼び出す関数を追加
    - その他改修
- 2024/11/27
    - _FRENでワイルドカードを使ったときの動きを確認するためのコードを追加
    - Makefileのcleanで削除し忘れていたファイルがあったので追加
    - _FREN(ファイル名の変更)ファンクションコールを呼び出す関数を追加
    - その他いろいろ変更
- 2024/11/18
    - _RDSEQ(シーケンシャルな読み込み)ファンクションコールを呼び出す関数を追加
- 2024/11/6
    - _FDEL(ファイルの削除)ファンクションコールを呼び出す関数を追加
    - _SFIRST、_SNEXT、_FFIRST、_FNEXTファンクションコールを呼び出すルーチンを追加
- 2024/11/5
    - bfile_fseekの追加およびbfile_read、bfile_writeなどにランダムアクセスに対応するための改修
- 2024/11/3
    - 自作のZ80エミュレータの終了コードを設定するファンクションコールを呼び出すルーチンを追加
- 2024/11/2
    - README.mdがちょっと微妙だったので変更
- 2024/11/2
    - 初めてのコミット
